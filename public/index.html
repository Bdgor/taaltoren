<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>TaalToren Puzzle</title>
  <link rel="icon" href="/favicon.png" type="image/x-icon" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    :root { --primary:#0ea5e9; }
    body { font-family: Arial, sans-serif; margin:0; }
    /* –ø–ª–∞–≤–∞—é—á–∞ –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
    .floating-tools{
      position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:1100;
    }
    .fab{
      width:48px; height:48px; border-radius:50%; border:none; cursor:pointer;
      background: var(--primary); color:#fff; font-size:22px; box-shadow:0 8px 24px rgba(0,0,0,.15);
    }
    /* –ø–∞–Ω–µ–ª—å —Ä–µ–π—Ç–∏–Ω–≥—É (–ø–æ—á–∞—Ç–∫–æ–≤–æ —Å—Ö–æ–≤–∞–Ω–∞) */
    #global-rating-corner{
      position: fixed; right: 12px; bottom: 72px; background: rgba(255,255,255,0.95);
      padding: 10px; border-radius: 10px; max-height: 50vh; overflow-y: auto; font-size: 14px;
      box-shadow:0 8px 24px rgba(0,0,0,.12); display:none; z-index:1050; min-width:240px;
    }
    body.dark { color:#e5e7eb; background:#0b0f19; }
    body.dark #global-rating-corner { background: rgba(15,23,42,0.95); color:#e5e7eb; }
    .option-row { display:flex; gap:10px; flex-wrap:wrap; }
    .option-button { padding:8px 12px; font-size:16px; }
    .correct { background:#a6f3a6; }
    .wrong { background:#f3a6a6; }
  </style>
</head>
<body>

<!-- –†–µ–π—Ç–∏–Ω–≥ (—ñ–∫–æ–Ω–∫–æ—é –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ) -->
<div id="global-rating-corner"></div>
<div class="floating-tools">
  <button id="toggle-rating" class="fab" title="–†–µ–π—Ç–∏–Ω–≥ üèÜ">üèÜ</button>
  <button id="toggle-speech" class="fab" title="–û–∑–≤—É—á–µ–Ω–Ω—è">üîä</button>
  <button id="toggle-theme" class="fab" title="–¢–µ–º–∞">üåì</button>
</div>

<!-- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è -->
<div id="register-section" style="margin-top: 40px;">
  <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
  <form id="registerForm" style="display:flex;flex-direction:column;max-width:320px;gap:10px;">
    <input type="text" name="username" placeholder="–õ–æ–≥—ñ–Ω" required />
    <input type="email" name="email" placeholder="E-mail" required />
    <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
    <button type="submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
    <div id="reg-msg" style="color:green"></div>
  </form>
</div>

<!-- –í—Ö—ñ–¥ -->
<div id="login-section" style="margin-top: 40px; display:none;">
  <h2>–í—Ö—ñ–¥</h2>
  <form id="loginForm" style="display:flex;flex-direction:column;max-width:320px;gap:10px;">
    <input type="text" id="login-username" placeholder="–õ–æ–≥—ñ–Ω" required />
    <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required />
    <button type="submit">–£–≤—ñ–π—Ç–∏</button>
    <div id="login-msg" style="color:red"></div>
  </form>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–∏—Ö–æ–¥—É -->
<button id="logout-button" onclick="logout()" style="display:none; margin-top: 20px;">–í–∏–π—Ç–∏</button>

<!-- –í–∏–±—ñ—Ä —Ä—ñ–≤–Ω—è -->
<div id="level-selection" style="display: none;">
  <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</h2>
  <button onclick="selectLevel('A0')">A0 (üî∞ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π)</button>
  <button onclick="selectLevel('A1')">A1 (‚öôÔ∏è –ë–∞–∑–æ–≤–∏–π)</button>
  <button onclick="selectLevel('A2')">A2 (üî• –í–∏—â–∏–π)</button>
</div>

<!-- –ì—Ä–∞ -->
<div id="game" style="display: none;">
  <div id="puzzle-canvas"></div>
  <h3 id="level-display"></h3>
  <p><strong id="player-name"></strong></p>
  <p id="score-display"></p>
  <p id="storm-timer"></p>
  <div id="question"></div>
  <div id="options" class="option-row"></div>
  <div id="session-rating"></div>
</div>

<script>
/* ---------------- Core state ---------------- */
let socket = io('https://terminusapp.nl', { transports: ['websocket'], secure: true });
let allScoresSession = { A0:{}, A1:{}, A2:{} };
let allScoresGlobal  = { A0:{}, A1:{}, A2:{} };
let lastServerTimer = 900, lastServerTimeUpdate = Date.now();

let scores = { A0:0, A1:0, A2:0 };
let activeLevel = null, score = 0, currentCSV = [], usedWords = [];
let playerName = '', wrongStreak = 0;

let speechReady = false;
let ttsOn = (localStorage.getItem('tts_on') ?? '1') === '1';   // –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–µ—Ä—É—î üîä
let themeOverride = localStorage.getItem('theme_mode');        // 'light'|'dark'|null

/* ---------------- Settings (theme/bg) ---------------- */
fetch('/settings/public').then(r=>r.json()).then(cfg=>{
  // —Ç–µ–º–∞ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (—è–∫ –¥–µ—Ñ–æ–ª—Ç), –∞–ª–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –ø–µ—Ä–µ–∫—Ä–∏—Ç–∏
  const serverTheme = cfg.theme || { mode:'light', primary:'#0ea5e9' };
  const mode = themeOverride || serverTheme.mode || 'light';
  applyTheme({ mode, primary: serverTheme.primary || '#0ea5e9' });

  // —Ñ–æ–Ω
  if (cfg.bg_image_url) {
    document.body.style.backgroundImage = `url(${cfg.bg_image_url})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundAttachment = 'fixed';
  } else {
    document.body.style.backgroundImage = 'none';
  }
});

/* ---------------- UI toggles ---------------- */
const btnRating = document.getElementById('toggle-rating');
const btnSpeech = document.getElementById('toggle-speech');
const btnTheme  = document.getElementById('toggle-theme');
const ratingBox = document.getElementById('global-rating-corner');

function setSpeechIcon(){ btnSpeech.textContent = ttsOn ? 'üîä' : 'üîá'; }
setSpeechIcon();

btnSpeech.onclick = () => {
  ttsOn = !ttsOn;
  localStorage.setItem('tts_on', ttsOn ? '1' : '0');
  setSpeechIcon();
};

btnTheme.onclick = () => {
  const isDark = document.body.classList.toggle('dark');
  const mode = isDark ? 'dark' : 'light';
  localStorage.setItem('theme_mode', mode);
  themeOverride = mode;
};

let ratingLoadedOnce = false;
btnRating.onclick = async () => {
  const visible = ratingBox.style.display === 'block';
  if (!visible && !ratingLoadedOnce) {
    try {
      const data = await fetch('/scores/public').then(r=>r.json());
      allScoresSession = data.scoresSession || allScoresSession;
      allScoresGlobal  = data.scoresGlobal  || allScoresGlobal;
      ratingLoadedOnce = true;
      updateTowersAndScores();
    } catch {}
  }
  ratingBox.style.display = visible ? 'none' : 'block';
};

function applyTheme(t){
  document.documentElement.style.setProperty('--primary', t.primary);
  document.body.classList.toggle('dark', (t.mode||'light') === 'dark');
}

/* ---------------- Speech helpers ---------------- */
function initSpeech(){
  if (!speechReady && window.speechSynthesis){
    let u = new SpeechSynthesisUtterance(" ");
    u.lang = 'nl-NL';
    window.speechSynthesis.speak(u);
    speechReady = true;
  }
}
function speakText(text, lang='nl-NL'){
  if (!ttsOn) return;
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  window.speechSynthesis.speak(u);
}

/* ---------------- Auth / load ---------------- */
window.onload = () => {
  const savedUser = localStorage.getItem('taaltoren_username');
  const savedLevel = localStorage.getItem('taaltoren_activeLevel');
  if (savedUser) {
    playerName = savedUser;
    document.getElementById('player-name').innerText = '–ì—Ä–∞–≤–µ—Ü—å: ' + playerName;
    document.getElementById('logout-button').style.display = 'inline-block';
    document.getElementById('register-section').style.display = 'none';
    document.getElementById('login-section').style.display = 'none';
    if (savedLevel) selectLevel(savedLevel); else showLevelSelection();
  } else {
    showAuthUI();
  }
};

function showAuthUI(){
  document.getElementById('register-section').style.display = 'block';
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('logout-button').style.display = 'none';
  document.getElementById('level-selection').style.display = 'none';
  document.getElementById('game').style.display = 'none';
}
function showLevelSelection(){
  document.getElementById('level-selection').style.display = 'block';
  document.getElementById('game').style.display = 'none';
}
function logout(){
  localStorage.removeItem('taaltoren_username');
  localStorage.removeItem('taaltoren_activeLevel');
  playerName=''; score=0; activeLevel=null;
  showAuthUI();
}

/* ---------------- Register / Login ---------------- */
document.getElementById('registerForm').onsubmit = async function(e){
  e.preventDefault(); initSpeech();
  const body = { username:e.target.username.value.trim(), email:e.target.email.value.trim(), password:e.target.password.value };
  const msg = document.getElementById('reg-msg');
  msg.style.color='black'; msg.innerText='–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...';
  try{
    const res = await fetch('https://terminusapp.nl/api/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (data.ok){ msg.style.color='green'; msg.innerText='–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.'; document.getElementById('login-username').value = body.username; }
    else { msg.style.color='red'; msg.innerText=data.msg||'–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó'; }
  }catch{ msg.style.color='red'; msg.innerText='–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'; }
};

document.getElementById('loginForm').onsubmit = async function(e){
  e.preventDefault(); initSpeech();
  const loginMsg = document.getElementById('login-msg');
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if(!username||!password){ loginMsg.innerText='–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å'; return; }
  loginMsg.innerText='–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';
  try{
    const res = await fetch('https://terminusapp.nl/api/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username,password }) });
    const data = await res.json();
    if (!data.ok){ loginMsg.innerText=data.msg||'–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É'; return; }
    playerName = data.user.username;
    scores = { A0:data.user.points||0, A1:data.user.points||0, A2:data.user.points||0 };
    score = data.user.points||0;
    localStorage.setItem('taaltoren_username', playerName);
    showLevelSelection();
    document.getElementById('register-section').style.display='none';
    document.getElementById('login-section').style.display='none';
    document.getElementById('logout-button').style.display='inline-block';
    document.getElementById('player-name').innerText='–ì—Ä–∞–≤–µ—Ü—å: '+playerName;
  }catch{ loginMsg.innerText='–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'; }
};

/* ---------------- Game ---------------- */
const PUZZLE_W=10, PUZZLE_H=10;
const puzzleImages=["puzzle1.jpg","puzzle2.jpg","puzzle3.jpg","puzzle4.jpg","puzzle5.jpg","puzzle6.jpg"];
let puzzleImg=puzzleImages[0], puzzleProgress=0;

function renderPuzzle(){
  const canvas=document.getElementById('puzzle-canvas'); canvas.innerHTML='';
  let frag=0;
  for(let y=0;y<PUZZLE_H;y++){
    for(let x=0;x<PUZZLE_W;x++){
      const div=document.createElement('div');
      div.className='puzzle-fragment'+(frag<puzzleProgress?' open':'');
      div.style.backgroundImage=`url('${puzzleImg}')`;
      div.style.backgroundPosition=`-${x*32}px -${y*20}px`;
      canvas.appendChild(div); frag++;
    }
  }
}

function selectLevel(level){
  activeLevel=level; score=scores[activeLevel]||0;
  localStorage.setItem('taaltoren_activeLevel', activeLevel);
  document.getElementById('level-selection').style.display='none';
  document.getElementById('game').style.display='block';
  document.getElementById('level-display').innerText='–†—ñ–≤–µ–Ω—å: '+activeLevel;
  document.getElementById('score-display').innerText='–û—á–∫–∏: '+score;
  wrongStreak=0; puzzleImg=puzzleImages[Math.floor(Math.random()*puzzleImages.length)];
  puzzleProgress=0; renderPuzzle();
  const csvFile = level==='A0'?'words.csv': level==='A1'?'words2.csv':'words3.csv';
  loadCSV(csvFile);
}

function loadCSV(file){
  fetch(file).then(res=>res.text()).then(text=>{
    const lines=text.trim().split('\n');
    currentCSV=lines.map(line=>{ const parts=line.split(',').map(p=>p.trim()); return { ua:parts[0], nl:parts[1] }; });
    shuffle(currentCSV); usedWords=[]; showNextWord();
  });
}

function showNextWord(){
  const available=currentCSV.filter(w=>!usedWords.includes(w.nl));
  if(!available.length) return;
  const word=available[Math.floor(Math.random()*available.length)];
  document.getElementById('question').innerHTML=
    `–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏: ${word.ua} <button onclick="speakText('${word.nl}','nl-NL')" style="font-size:18px; margin-left:5px;">üîä</button>`;
  const correct=word.nl;
  const options=[correct, generateMistake(correct), generateMistake(correct)];
  shuffle(options);
  const box=document.getElementById('options'); box.innerHTML='';
  options.forEach(opt=>{
    const btn=document.createElement('button');
    btn.innerText=opt; btn.className='option-button';
    btn.onclick=()=>handleAnswer(btn,opt,correct,word,box);
    box.appendChild(btn);
  });
}

function handleAnswer(btn, selected, correct, word, container){
  Array.from(container.children).forEach(b=>b.disabled=true);
  if(selected===correct){
    btn.classList.add('correct'); speakText(correct,'nl-NL');
    setTimeout(()=>{
      increaseScore(); wrongStreak=0; usedWords.push(word.nl);
      puzzleProgress++; renderPuzzle(); addBlock(word.nl); showNextWord();
    },1000);
  }else{
    btn.classList.add('wrong');
    Array.from(container.children).forEach(b=>{ if(b.innerText===correct) b.classList.add('correct'); });
    wrongStreak++; let minus = wrongStreak<3 ? 1 : 2;
    score=Math.max(0, score-minus); scores[activeLevel]=score;
    document.getElementById('score-display').innerText='–û—á–∫–∏: '+score;
    if(socket && activeLevel) socket.emit("sub-block", { user:playerName, level:activeLevel, minus });
    setTimeout(()=>showNextWord(),3000);
  }
}

function increaseScore(){ score++; scores[activeLevel]=score; document.getElementById('score-display').innerText='–û—á–∫–∏: '+score; }
function addBlock(word){ if(socket && activeLevel) socket.emit("add-block",{ user:playerName, word, level:activeLevel }); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function generateMistake(word){ if(word.length<2) return word+'x'; let arr=word.split(''); let i=Math.floor(Math.random()*(word.length-1)); [arr[i],arr[i+1]]=[arr[i+1],arr[i]]; return arr.join(''); }

/* ---------------- Timer & Scores ---------------- */
socket.on("tick", ({timer})=>{ lastServerTimer=timer; lastServerTimeUpdate=Date.now(); });
setInterval(()=>{
  const elapsed=Math.floor((Date.now()-lastServerTimeUpdate)/1000);
  const left=Math.max(0,lastServerTimer-elapsed);
  document.getElementById('storm-timer').innerText=`–î–æ –±—É—Ä—ñ: ${String(Math.floor(left/60)).padStart(2,'0')}:${String(left%60).padStart(2,'0')}`;
},1000);

socket.on("sync", ({scoresSession, scoresGlobal})=>{
  allScoresSession=scoresSession||{A0:{},A1:{},A2:{}}; 
  allScoresGlobal=scoresGlobal||{A0:{},A1:{},A2:{}}; 
  if (ratingBox.style.display==='block') updateTowersAndScores();
});

function updateTowersAndScores(){
  const lvl = activeLevel || 'A0';
  const sessionDiv=document.getElementById('session-rating');
  let s1=Object.entries(allScoresSession[lvl]||{}).sort((a,b)=>b[1]-a[1]);
  sessionDiv.innerHTML = `<h4>–†–µ–π—Ç–∏–Ω–≥ —Å–µ—Å—ñ—ó (${lvl})</h4>` + s1.map(([u,s],i)=>`${i+1}. ${u}: <b>${s}</b>`).join('<br>');
  let s2=Object.entries(allScoresGlobal[lvl]||{}).sort((a,b)=>b[1]-a[1]);
  ratingBox.innerHTML = `<h4>–ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (${lvl})</h4>` + s2.map(([u,s],i)=>`${i+1}. ${u}: <b>${s}</b>`).join('<br>');
}
</script>
  <script defer src="/feature-tiles.js"></script>
</body>
</html>
