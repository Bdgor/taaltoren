<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>TaalToren</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #tower { margin-bottom: 20px; }
    #tower .block, .block {
      width: 100px;
      height: 20px;
      background: #4caf50;
      color: white;
      font-weight: bold;
      margin: 2px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .option-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 16px;
      margin: 20px 0;
    }
    .option-button { 
      margin: 0;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      min-width: 120px;
    }
    #storm-timer {
      font-weight: bold;
      color: #b94a48;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #all-towers {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      margin: 30px 0;
      gap: 32px;
    }
    #all-towers > div {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 10px;
      min-width: 120px;
      min-height: 40px;
      box-shadow: 0 0 4px #bbb;
    }
    #rating {
      margin-bottom: 30px;
    }
  </style>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

  <div id="username-section" style="margin-top: 50px;">
    <h2>–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è</h2>
    <input type="text" id="username-input" placeholder="–í–∞—à–µ —ñ–º'—è">
    <button onclick="submitName()">–ü–æ—á–∞—Ç–∏</button>
  </div>

  <div id="level-selection" style="display: none;">
    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</h2>
    <button onclick="selectLevel('A0')">A0 (üî∞ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A1')">A1 (‚öôÔ∏è –ë–∞–∑–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A2')">A2 (üî• –í–∏—â–∏–π)</button>
  </div>

  <div id="game" style="display: none;">
    <!-- –í–µ–∂–∞ –∑–≤–µ—Ä—Ö—É -->
    <div id="tower"></div>

    <h3 id="level-display"></h3>
    <p><strong id="player-name"></strong></p>
    <p id="score-display"></p>
    <p id="storm-timer"></p>
    <div id="question"></div>
    <!-- –í–∞—Ä—ñ–∞–Ω—Ç–∏ —É flex-—Ä—è–¥–∫—É -->
    <div id="options" class="option-row"></div>

    <div id="rating"></div>
    <div id="all-towers"></div>
  </div>

  <script>
    // –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –î–û SOCKET.IO –°–ï–†–í–ï–†–£
    let socket = io("http://localhost:3000"); // –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π –¥–æ–º–µ–Ω/–ø–æ—Ä—Ç –ø—Ä–∏ –ø—Ä–æ–¥–∞–∫—à–Ω
    let allTowers = {};
    let allScores = {};
    let serverTimer = 900;

    let scores = JSON.parse(localStorage.getItem('taaltoren_scores')) || { A0: 0, A1: 0, A2: 0 };
    let activeLevel = localStorage.getItem('taaltoren_activeLevel') || null;
    let score = 0;
    let currentCSV = [];
    let usedWords = [];
    let wrongAnswers = 0;
    let playerName = localStorage.getItem('taaltoren_username') || '';

    // –¢–∞–π–º–µ—Ä –±—É—Ä—ñ (–ª–∏—à–µ –¥–ª—è –≤—ñ–¥–ª—ñ–∫—É, —Ñ–∞–∫—Ç–∏—á–Ω–∏–π storm ‚Äî —ñ–∑ —Å–µ—Ä–≤–µ—Ä—É)
    let stormCountdownInterval = null;

    // Socket.IO handlers
    socket.on("sync", ({ towers, scores }) => {
      allTowers = towers || {};
      allScores = scores || {};
      updateTowersAndScores();
    });

    socket.on("tick", ({ timer }) => {
      serverTimer = timer;
      updateStormCountdown(serverTimer);
    });

    socket.on("clear", () => {
      clearTower();
      usedWords = [];
      // –û—á–∏—â–∞—î–º–æ —Å–≤–æ—é tower –Ω–∞ –µ–∫—Ä–∞–Ω—ñ
      document.getElementById('tower').innerHTML = '';
    });

    // ==== –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –ì–†–ò –ü–†–ò –û–ù–û–í–õ–ï–ù–ù–Ü ====
    if (playerName) {
      document.getElementById('username-section').style.display = 'none';
      if (activeLevel) {
        selectLevel(activeLevel, true); // –æ–¥—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞—î–º–æ –≥—Ä—É –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ
      } else {
        document.getElementById('level-selection').style.display = 'block';
      }
    }

    function submitName() {
      const nameInput = document.getElementById('username-input').value.trim();
      if (!nameInput) return;
      playerName = nameInput;
      localStorage.setItem('taaltoren_username', playerName);
      document.getElementById('username-section').style.display = 'none';
      if (activeLevel) {
        selectLevel(activeLevel, true);
      } else {
        document.getElementById('level-selection').style.display = 'block';
      }
    }

    function selectLevel(level, isReload = false) {
      activeLevel = level;
      localStorage.setItem('taaltoren_activeLevel', activeLevel);
      score = scores[activeLevel] || 0;
      document.getElementById('level-selection').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById('level-display').innerText = '–†—ñ–≤–µ–Ω—å: ' + activeLevel;
      document.getElementById('player-name').innerText = '–ì—Ä–∞–≤–µ—Ü—å: ' + playerName;
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;

      const csvFile = level === 'A0' ? 'words.csv' : level === 'A1' ? 'words2.csv' : 'words3.csv';
      loadCSV(csvFile, isReload);
    }

    function loadCSV(file, isReload = false) {
      fetch(file)
        .then(res => res.text())
        .then(text => {
          const lines = text.trim().split('\n');
          currentCSV = lines.map(line => {
            const parts = line.split(',');
            const ua = parts[0] ? parts[0].trim() : '';
            // –î–ª—è –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º—É —Å–ª–æ–≤–∞ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏, –∞ –Ω–µ –ª–∏—à–µ –æ–¥–Ω–µ nl
            // –¢—É—Ç –±–µ—Ä–µ–º–æ —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –¥—Ä—É–≥–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å (—É —Ñ–∞–π–ª—ñ: —É–∫—Ä, nl, ...), –∞–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –∑–∞–ª–∏—à–∞—î–º–æ —Ç–∞–∫:
            const nl = parts[1] ? parts[1].trim() : '';
            return { ua, nl };
          });
          shuffle(currentCSV);
          usedWords = [];
          clearTower();
          if (!isReload) {
            document.getElementById('tower').innerHTML = '';
          }
          showNextWord();
        });
    }

    function showNextWord() {
      const availableWords = currentCSV.filter(word => !usedWords.includes(word.nl));
      if (availableWords.length === 0) return;
      const word = availableWords[Math.floor(Math.random() * availableWords.length)];

      document.getElementById('question').innerText = `–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏: ${word.ua}`;

      const correct = word.nl;
      const options = [correct, generateMistake(correct), generateMistake(correct)];
      shuffle(options);

      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt;
        btn.className = 'option-button';
        btn.onclick = () => checkAnswer(opt, correct, word);
        optionsContainer.appendChild(btn);
      });
    }

    function checkAnswer(selected, correct, word) {
      if (selected === correct) {
        increaseScore();
        usedWords.push(word.nl);
        addBlock(word.nl);
        wrongAnswers = 0;
      } else {
        score = Math.max(0, score - 1);
        scores[activeLevel] = score;
        localStorage.setItem('taaltoren_scores', JSON.stringify(scores));
        document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;
        wrongAnswers++;
        if (wrongAnswers >= 3) {
          triggerStorm();
          return;
        }
      }
      showNextWord();
    }

    function increaseScore() {
      score++;
      scores[activeLevel] = score;
      localStorage.setItem('taaltoren_scores', JSON.stringify(scores));
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;
    }

    // === –î–æ–¥–∞—î–º–æ –±–ª–æ–∫ –Ω–µ –ª–∏—à–µ –ª–æ–∫–∞–ª—å–Ω–æ, –∞ –π –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ ===
    function addBlock(word) {
      const block = document.createElement('div');
      block.className = 'block';
      block.innerText = word;
      document.getElementById('tower').appendChild(block);

      // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –∑ —Å–µ—Ä–≤–µ—Ä–æ–º
      socket.emit("add-block", { user: playerName, word });
    }

    function clearTower() {
      document.getElementById('tower').innerHTML = '';
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateMistake(word) {
      if (word.length < 2) return word + 'x';
      let arr = word.split('');
      let i = Math.floor(Math.random() * (word.length - 1));
      [arr[i], arr[i + 1]] = [arr[i + 1], arr[i]];
      return arr.join('');
    }

    function triggerStorm(isTimer = false) {
      alert("–ë—É—Ä—è –∑—Ä—É–π–Ω—É–≤–∞–ª–∞ –≤–∞—à—É –≤–µ–∂—É!");
      clearTower();
      usedWords = [];
      document.getElementById('storm-timer').innerText = '';
      localStorage.removeItem('taaltoren_activeLevel'); // –°–∫–∏–¥–∞—î–º–æ —Ä—ñ–≤–µ–Ω—å –¥–æ –≤–∏–±–æ—Ä—É

      document.getElementById('game').style.display = 'none';
      document.getElementById('level-selection').style.display = 'block';
      // –î–∞–ª—ñ –º–æ–∂–Ω–∞ –±–ª–æ–∫—É–≤–∞—Ç–∏ —Ä—ñ–≤–Ω—ñ, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    }

    // === –û–ù–û–í–õ–ï–ù–ù–Ø –í–ï–ñ –¢–ê –†–ï–ô–¢–ò–ù–ì–£ ===
    function updateTowersAndScores() {
      // –í—Å—ñ towers (–∫—Ä—ñ–º —Å–≤–æ—î—ó)
      const allTowersDiv = document.getElementById('all-towers');
      allTowersDiv.innerHTML = '';
      Object.keys(allTowers).forEach(user => {
        if (user === playerName) return; // —Å–≤–æ—é –≤–µ–∂—É –ø–æ–∫–∞–∑—É—î–º–æ –æ–∫—Ä–µ–º–æ
        const blocks = allTowers[user].map(b => `<div class="block">${b.word}</div>`).join('');
        allTowersDiv.innerHTML += `<div><strong>${user}:</strong><br>${blocks}</div>`;
      });
      // –†–µ–π—Ç–∏–Ω–≥
      const ratingDiv = document.getElementById('rating');
      let sorted = Object.entries(allScores).sort((a,b) => b[1]-a[1]);
      ratingDiv.innerHTML = `<h4>–†–µ–π—Ç–∏–Ω–≥ –≥—Ä–∞–≤—Ü—ñ–≤</h4>` +
        sorted.map(([user, sc], idx) =>
          `<div>${idx+1}. ${user}: <b>${sc}</b></div>`
        ).join('');
    }

    // === –¢–∞–π–º–µ—Ä –¥–æ –±—É—Ä—ñ, —â–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º ===
    function updateStormCountdown(serverTimerVal = null) {
      clearInterval(stormCountdownInterval);
      const timerElem = document.getElementById('storm-timer');
      if (!timerElem) return;
      let remaining = serverTimerVal || 900;
      stormCountdownInterval = setInterval(() => {
        if (remaining <= 0) {
          timerElem.innerText = '';
          clearInterval(stormCountdownInterval);
          return;
        }
        let min = Math.floor(remaining / 60);
        let sec = Math.floor(remaining % 60);
        timerElem.innerText = `–î–æ –±—É—Ä—ñ: ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        remaining -= 1;
      }, 1000);
    }
  </script>
</body>
</html>
