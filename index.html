<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>TaalToren</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #tower .block {
      width: 100px;
      height: 20px;
      background: #4caf50;
      color: white;
      font-weight: bold;
      margin: 2px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .option-button { display: block; margin: 10px auto; padding: 10px 15px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="username-section" style="margin-top: 50px;">
    <h2>–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è</h2>
    <input type="text" id="username-input" placeholder="–í–∞—à–µ —ñ–º'—è">
    <button onclick="submitName()">–ü–æ—á–∞—Ç–∏</button>
  </div>

  <div id="level-selection" style="display: none;">
    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</h2>
    <button onclick="selectLevel('A0')">A0 (üî∞ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A1')">A1 (‚öôÔ∏è –ë–∞–∑–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A2')">A2 (üî• –í–∏—â–∏–π)</button>
  </div>

  <div id="game" style="display: none;">
    <h3 id="level-display"></h3>
    <p><strong id="player-name"></strong></p>
    <p id="score-display"></p>
    <div id="question"></div>
    <div id="options"></div>
    <div id="tower"></div>
  </div>

  <script>
    let scores = JSON.parse(localStorage.getItem('taaltoren_scores')) || { A0: 0, A1: 0, A2: 0 };
    let activeLevel = null;
    let score = 0;
    let currentCSV = [];
    let currentWordIndex = 0;
    let wrongAnswers = 0;
    let playerName = localStorage.getItem('taaltoren_username') || '';

    if (playerName) {
      document.getElementById('username-section').style.display = 'none';
      document.getElementById('level-selection').style.display = 'block';
    }

    function submitName() {
      const nameInput = document.getElementById('username-input').value.trim();
      if (!nameInput) return;
      playerName = nameInput;
      localStorage.setItem('taaltoren_username', playerName);
      document.getElementById('username-section').style.display = 'none';
      document.getElementById('level-selection').style.display = 'block';
    }

    function selectLevel(level) {
      activeLevel = level;
      score = scores[activeLevel] || 0;
      document.getElementById('level-selection').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById('level-display').innerText = '–†—ñ–≤–µ–Ω—å: ' + activeLevel;
      document.getElementById('player-name').innerText = '–ì—Ä–∞–≤–µ—Ü—å: ' + playerName;
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;

      const csvFile = level === 'A0' ? 'words.csv' : level === 'A1' ? 'words2.csv' : 'words3.csv';
      loadCSV(csvFile);
    }

    function loadCSV(file) {
      fetch(file)
        .then(res => res.text())
        .then(text => {
          const lines = text.trim().split('\n');
          currentCSV = lines.map(line => {
            const [ua, nl] = line.split(',');
            return { ua: ua.trim(), nl: nl.trim() };
          });
          shuffle(currentCSV);
          showNextWord();
        });
    }

    function showNextWord() {
      if (currentCSV.length === 0) return;
      currentWordIndex = Math.floor(Math.random() * currentCSV.length);
      const word = currentCSV[currentWordIndex];
      document.getElementById('question').innerText = `–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏: ${word.ua}`;

      const correct = word.nl;
      const options = [correct, generateMistake(correct), generateMistake(correct)];
      shuffle(options);

      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt;
        btn.className = 'option-button';
        btn.onclick = () => checkAnswer(opt);
        optionsContainer.appendChild(btn);
      });
    }

    function checkAnswer(selected) {
      const correct = currentCSV[currentWordIndex].nl;
      if (selected === correct) {
        increaseScore();
        addBlock(currentCSV[currentWordIndex].nl);
        wrongAnswers = 0;
      } else {
        wrongAnswers++;
        if (wrongAnswers >= 3) {
          triggerStorm();
          return;
        }
      }
      showNextWord();
    }

    function increaseScore() {
      score++;
      scores[activeLevel] = score;
      localStorage.setItem('taaltoren_scores', JSON.stringify(scores));
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;
    }

    function addBlock(word) {
      const block = document.createElement('div');
      block.className = 'block';
      block.innerText = word;
      document.getElementById('tower').appendChild(block);
    }

    function clearTower() {
      document.getElementById('tower').innerHTML = '';
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateMistake(word) {
      if (word.length < 2) return word + 'x';
      let arr = word.split('');
      let i = Math.floor(Math.random() * (word.length - 1));
      [arr[i], arr[i + 1]] = [arr[i + 1], arr[i]];
      return arr.join('');
    }

    function triggerStorm() {
      alert("–ë—É—Ä—è –∑—Ä—É–π–Ω—É–≤–∞–ª–∞ –≤–∞—à—É –≤–µ–∂—É!");
      clearTower();

      document.getElementById('game').style.display = 'none';
      document.getElementById('level-selection').style.display = 'block';

      const buttons = document.querySelectorAll('#level-selection button');
      const levelOrder = ['A0', 'A1', 'A2'];
      const currentIndex = levelOrder.indexOf(activeLevel);

      buttons.forEach(btn => {
        const level = btn.innerText.includes('A0') ? 'A0' : btn.innerText.includes('A1') ? 'A1' : 'A2';
        const btnIndex = levelOrder.indexOf(level);
        btn.disabled = Math.abs(btnIndex - currentIndex) > 1;
      });
    }
  </script>
</body>
</html>
