<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>TaalToren — Вежа слів</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
        }
        .tower {
            margin: 20px auto;
            width: 100px;
        }
        .block {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            margin: 2px 0;
            border-radius: 4px;
            animation: drop 0.3s ease;
        }
        @keyframes drop {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .question {
            margin: 20px;
            font-size: 20px;
        }
        .options button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }
        #timer {
            font-size: 18px;
            color: #555;
        }
        #score {
            font-size: 20px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>TaalToren — Вежа слів</h1>
    <div id="timer">Наступна буря через: <span id="countdown">15:00</span></div>
    <div id="score">Висота вежі: 0</div>
    <div class="tower" id="tower"></div>
    <div class="question" id="question"></div>
    <div class="options" id="options"></div>

    <script>
        const socket = io("https://taaltoren.onrender.com");

        let words = [];
        let usedIndexes = new Set();
        let currentIndex = 0;

        async function loadWords() {
            const response = await fetch("words.csv");
            const text = await response.text();
            const lines = text.trim().split("\n");
            words = lines.map(line => {
                const [ua, correct, wrong1, wrong2] = line.split(",");
                return { ua, correct, wrong: [wrong1, wrong2] };
            });
            shuffle(words);
            nextQuestion();
        }

        let tower = [];
        let timer = 900;

        socket.on("sync", data => {
            tower = data.tower || [];
            renderTower();
        });

        socket.on("clear", () => {
            tower = [];
            renderTower();
        });

        socket.on("tick", data => {
            timer = data.timer;
            const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
            const seconds = String(timer % 60).padStart(2, '0');
            document.getElementById("countdown").innerText = `${minutes}:${seconds}`;
        });

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function nextQuestion() {
            if (usedIndexes.size >= words.length) {
                usedIndexes.clear();
                shuffle(words);
            }
            do {
                currentIndex = Math.floor(Math.random() * words.length);
            } while (usedIndexes.has(currentIndex));
            usedIndexes.add(currentIndex);

            const item = words[currentIndex];
            document.getElementById("question").innerText = `Як буде "${item.ua}" нідерландською?`;
            let options = [item.correct, ...item.wrong];
            shuffle(options);

            const optionsDiv = document.getElementById("options");
            optionsDiv.innerHTML = "";
            options.forEach(option => {
                const btn = document.createElement("button");
                btn.innerText = option;
                btn.onclick = () => {
                    if (option === item.correct) {
                        socket.emit("add-block", item.correct);
                        playSound('correct');
                    } else {
                        playSound('wrong');
                    }
                    nextQuestion();
                };
                optionsDiv.appendChild(btn);
            });
        }

        function renderTower() {
            const towerDiv = document.getElementById("tower");
            const scoreDiv = document.getElementById("score");
            towerDiv.innerHTML = "";
            tower.slice().reverse().forEach(text => {
                const block = document.createElement("div");
                block.className = "block";
                block.innerText = text;
                towerDiv.appendChild(block);
            });
            scoreDiv.innerText = `Висота вежі: ${tower.length}`;
        }

        function playSound(type) {
            const sounds = {
                correct: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_96f7e97907.mp3'),
                wrong: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_88195d96a7.mp3'),
                storm: new Audio('https://cdn.pixabay.com/audio/2022/02/23/audio_1ad76fc186.mp3')
            };
            if (sounds[type]) sounds[type].play();
        }

        loadWords();
    </script>
</body>
</html>
