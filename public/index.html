<!DOCTYPE html> 
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>TaalToren Puzzle</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

  <div id="global-rating-corner"></div>

  <!-- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è -->
  <div id="register-section" style="margin-top: 40px;">
    <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
    <form id="registerForm" style="display:flex;flex-direction:column;max-width:320px;gap:10px;">
      <input type="text" name="username" placeholder="–õ–æ–≥—ñ–Ω" required />
      <input type="email" name="email" placeholder="E-mail" required />
      <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
      <button type="submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
      <div id="reg-msg" style="color:green"></div>
    </form>
  </div>

  <!-- –í—Ö—ñ–¥ -->
  <div id="login-section" style="margin-top: 40px; display:none;">
    <h2>–í—Ö—ñ–¥</h2>
    <form id="loginForm" style="display:flex;flex-direction:column;max-width:320px;gap:10px;">
      <input type="text" id="login-username" placeholder="–õ–æ–≥—ñ–Ω" required />
      <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required />
      <button type="submit">–£–≤—ñ–π—Ç–∏</button>
      <div id="login-msg" style="color:red"></div>
    </form>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –≤–∏—Ö–æ–¥—É -->
  <button id="logout-button" onclick="logout()" style="display:none; margin-top: 20px;">–í–∏–π—Ç–∏</button>

  <!-- –í–∏–±—ñ—Ä —Ä—ñ–≤–Ω—è -->
  <div id="level-selection" style="display: none;">
    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</h2>
    <button onclick="selectLevel('A0')">A0 (üî∞ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A1')">A1 (‚öôÔ∏è –ë–∞–∑–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A2')">A2 (üî• –í–∏—â–∏–π)</button>
  </div>

  <!-- –ì—Ä–∞ -->
  <div id="game" style="display: none;">
    <div id="puzzle-canvas"></div>
    <h3 id="level-display"></h3>
    <p><strong id="player-name"></strong></p>
    <p id="score-display"></p>
    <p id="storm-timer"></p>
    <div id="question"></div>
    <div id="options" class="option-row"></div>
    <div id="session-rating"></div>
  </div>

<script>
  let socket = io();

  let allScoresSession = { A0: {}, A1: {}, A2: {} };
  let allScoresGlobal  = { A0: {}, A1: {}, A2: {} };
  let lastServerTimer = 900;
  let lastServerTimeUpdate = Date.now();

  let scores = { A0: 0, A1: 0, A2: 0 };
  let activeLevel = null;
  let score = 0;
  let currentCSV = [];
  let usedWords = [];
  let playerName = '';
  let wrongStreak = 0;

  // –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
  window.onload = () => {
    const savedUser = localStorage.getItem('taaltoren_username');
    const savedLevel = localStorage.getItem('taaltoren_activeLevel');

    if (savedUser) {
      playerName = savedUser;
      document.getElementById('player-name').innerText = '–ì—Ä–∞–≤–µ—Ü—å: ' + playerName;
      document.getElementById('logout-button').style.display = 'inline-block';
      document.getElementById('register-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'none';

      if (savedLevel) {
        selectLevel(savedLevel);
      } else {
        showLevelSelection();
      }
    } else {
      showAuthUI();
    }
  };

  function showAuthUI() {
    document.getElementById('register-section').style.display = 'block';
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('logout-button').style.display = 'none';
    document.getElementById('level-selection').style.display = 'none';
    document.getElementById('game').style.display = 'none';
  }

  function showLevelSelection() {
    document.getElementById('level-selection').style.display = 'block';
    document.getElementById('game').style.display = 'none';
  }

  function showGame() {
    document.getElementById('level-selection').style.display = 'none';
    document.getElementById('game').style.display = 'block';
  }

  function logout() {
    localStorage.removeItem('taaltoren_username');
    localStorage.removeItem('taaltoren_activeLevel');
    playerName = '';
    score = 0;
    activeLevel = null;
    showAuthUI();
  }

  // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  document.getElementById('registerForm').onsubmit = async function(e) {
    e.preventDefault();
    const form = e.target;
    const body = {
      username: form.username.value.trim(),
      email: form.email.value.trim(),
      password: form.password.value
    };
    const regMsg = document.getElementById('reg-msg');
    regMsg.style.color = 'black';
    regMsg.innerText = '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...';
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.ok) {
      regMsg.style.color = 'green';
      regMsg.innerText = '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.';
      setTimeout(() => {
        document.getElementById('login-username').value = body.username;
        regMsg.innerText = '';
      }, 1000);
    } else {
      regMsg.style.color = 'red';
      regMsg.innerText = data.msg || '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó';
    }
  };

  // –õ–æ–≥—ñ–Ω
  document.getElementById('loginForm').onsubmit = async function(e) {
    e.preventDefault();
    const loginMsg = document.getElementById('login-msg');
    loginMsg.innerText = '';
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    if (!username || !password) {
      loginMsg.innerText = '–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å';
      return;
    }
    loginMsg.innerText = '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (!data.ok) {
      loginMsg.innerText = data.msg || '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É';
      return;
    }
    // –£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
    playerName = data.user.username;
    scores = { A0: data.user.points || 0, A1: data.user.points || 0, A2: data.user.points || 0 };
    score = data.user.points || 0;

    localStorage.setItem('taaltoren_username', playerName);

    showLevelSelection();
    document.getElementById('register-section').style.display = 'none';
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('logout-button').style.display = 'inline-block';
    document.getElementById('player-name').innerText = '–ì—Ä–∞–≤–µ—Ü—å: ' + playerName;
  };

  // --- –ü–∞–∑–ª ---
  const PUZZLE_W = 10, PUZZLE_H = 10;
  const puzzleImages = [
    "puzzle1.jpg", "puzzle2.jpg", "puzzle3.jpg",
    "puzzle4.jpg", "puzzle5.jpg", "puzzle6.jpg"
  ];
  let puzzleImg = puzzleImages[0];
  let puzzleProgress = 0;

  function renderPuzzle() {
    const canvas = document.getElementById('puzzle-canvas');
    if (!canvas) return;
    canvas.innerHTML = '';
    let frag = 0;
    for (let y = 0; y < PUZZLE_H; y++) {
      for (let x = 0; x < PUZZLE_W; x++) {
        const div = document.createElement('div');
        div.className = 'puzzle-fragment' + (frag < puzzleProgress ? ' open' : '');
        div.style.backgroundImage = `url('${puzzleImg}')`;
        div.style.backgroundPosition = `-${x*32}px -${y*20}px`;
        canvas.appendChild(div);
        frag++;
      }
    }
  }

  // --- –ì—Ä–∞ ---
  function selectLevel(level) {
    activeLevel = level;
    score = scores[activeLevel] || 0;
    localStorage.setItem('taaltoren_activeLevel', activeLevel);

    document.getElementById('level-selection').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    document.getElementById('level-display').innerText = '–†—ñ–≤–µ–Ω—å: ' + activeLevel;
    document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;

    wrongStreak = 0;
    puzzleImg = puzzleImages[Math.floor(Math.random() * puzzleImages.length)];
    puzzleProgress = 0;
    renderPuzzle();

    const csvFile = level === 'A0' ? 'words.csv' : level === 'A1' ? 'words2.csv' : 'words3.csv';
    loadCSV(csvFile);
  }

  function loadCSV(file) {
    fetch(file)
      .then(res => res.text())
      .then(text => {
        const lines = text.trim().split('\n');
        currentCSV = lines.map(line => {
          const parts = line.split(',');
          return { ua: parts[0].trim(), nl: parts[1].trim() };
        });
        shuffle(currentCSV);
        usedWords = [];
        showNextWord();
      });
  }

  function showNextWord() {
    const availableWords = currentCSV.filter(w => !usedWords.includes(w.nl));
    if (availableWords.length === 0) return;
    const word = availableWords[Math.floor(Math.random() * availableWords.length)];

    document.getElementById('question').innerHTML =
      `–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏: ${word.ua} <button onclick="speakText('${word.nl}', 'nl-NL')" style="font-size:18px; margin-left:5px;">üîä</button>`;

    const correct = word.nl;
    const options = [correct, generateMistake(correct), generateMistake(correct)];
    shuffle(options);

    const optionsContainer = document.getElementById('options');
    optionsContainer.innerHTML = '';
    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.innerText = opt;
      btn.className = 'option-button';
      btn.onclick = () => handleAnswer(btn, opt, correct, word, optionsContainer);
      optionsContainer.appendChild(btn);
    });
  }

  function handleAnswer(btn, selected, correct, word, optionsContainer) {
    Array.from(optionsContainer.children).forEach(b => b.disabled = true);
    if (selected === correct) {
      btn.classList.add('correct');
      speakText(correct, 'nl-NL');
      setTimeout(() => {
        increaseScore();
        wrongStreak = 0;
        usedWords.push(word.nl);
        puzzleProgress++;
        renderPuzzle();
        addBlock(word.nl);
        showNextWord();
      }, 1000);
    } else {
      btn.classList.add('wrong');
      Array.from(optionsContainer.children).forEach(b => {
        if (b.innerText === correct) b.classList.add('correct');
      });
      wrongStreak++;
      let minus = wrongStreak < 3 ? 1 : 2;
      score = Math.max(0, score - minus);
      scores[activeLevel] = score;
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;
      if (socket && activeLevel) {
        socket.emit("sub-block", { user: playerName, level: activeLevel, minus });
      }
      setTimeout(() => showNextWord(), 3000);
    }
  }

  function increaseScore() {
    score++;
    scores[activeLevel] = score;
    document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;
  }

  function addBlock(word) {
    if (socket && activeLevel) {
      socket.emit("add-block", { user: playerName, word, level: activeLevel });
    }
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function generateMistake(word) {
    if (word.length < 2) return word + 'x';
    let arr = word.split('');
    let i = Math.floor(Math.random() * (word.length - 1));
    [arr[i], arr[i + 1]] = [arr[i + 1], arr[i]];
    return arr.join('');
  }

  function triggerStorm() {
    alert("–ë—É—Ä—è –∑—Ä—É–π–Ω—É–≤–∞–ª–∞ –≤–∞—à—É –≤–µ–∂—É (—Ç–∞ –ø–∞–∑–ª)!");
    puzzleProgress = 0;
    renderPuzzle();
    usedWords = [];
    document.getElementById('storm-timer').innerText = '';
    // –û—á–∏—â–∞—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Ä—ñ–≤–µ–Ω—å, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–±—ñ—Ä –∑–Ω–æ–≤—É
    localStorage.removeItem('taaltoren_activeLevel');
    // –ü–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–±—ñ—Ä —Ä—ñ–≤–Ω—è
    document.getElementById('game').style.display = 'none';
    document.getElementById('level-selection').style.display = 'block';
  }

  function speakText(text, lang='nl-NL') {
    if (!window.speechSynthesis) return;
    let utter = new window.SpeechSynthesisUtterance(text);
    utter.lang = lang;
    window.speechSynthesis.speak(utter);
  }

  // --- –¢–∞–π–º–µ—Ä –±—É—Ä—ñ ---
  socket.on("tick", ({ timer }) => {
    lastServerTimer = timer;
    lastServerTimeUpdate = Date.now();
  });

  setInterval(() => {
    const elapsed = Math.floor((Date.now() - lastServerTimeUpdate) / 1000);
    const left = Math.max(0, lastServerTimer - elapsed);
    const timerElem = document.getElementById('storm-timer');
    if (timerElem) {
      let min = Math.floor(left / 60);
      let sec = Math.floor(left % 60);
      timerElem.innerText = `–î–æ –±—É—Ä—ñ: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
  }, 1000);

  // --- –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤ ---
  socket.on("sync", ({ scoresSession, scoresGlobal }) => {
    allScoresSession = scoresSession || { A0: {}, A1: {}, A2: {} };
    allScoresGlobal  = scoresGlobal  || { A0: {}, A1: {}, A2: {} };
    updateTowersAndScores();
  });

  function updateTowersAndScores() {
    const sessionDiv = document.getElementById('session-rating');
    let lvl = activeLevel || 'A0';
    let sortedSession = Object.entries(allScoresSession[lvl] || {}).sort((a, b) => b[1] - a[1]);
    sessionDiv.innerHTML = `<h4>–†–µ–π—Ç–∏–Ω–≥ —Ü—ñ—î—ó —Å–µ—Å—ñ—ó (${lvl})</h4>` +
      sortedSession.map(([user, sc], idx) =>
        `<div>${idx + 1}. ${user}: <b>${sc}</b></div>`
      ).join('');

    const cornerDiv = document.getElementById('global-rating-corner');
    let sortedGlobal = Object.entries(allScoresGlobal[lvl] || {}).sort((a, b) => b[1] - a[1]);
    cornerDiv.innerHTML = `<h4 style="margin:0 0 8px 0">–ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (${lvl})</h4>` +
      sortedGlobal.map(([user, sc], idx) =>
        `<div style="font-size:15px">${idx + 1}. ${user}: <b>${sc}</b></div>`
      ).join('');
  }
</script>

</body>
</html>

