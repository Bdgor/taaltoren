<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>TaalToren</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #tower div { width: 100px; height: 20px; background: black; margin: 2px auto; }
  </style>
</head>
<body>

  <div id="level-selection" style="margin-top: 50px;">
    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</h2>
    <button onclick="selectLevel('A0')">A0 (üî∞ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A1')">A1 (‚öôÔ∏è –ë–∞–∑–æ–≤–∏–π)</button>
    <button onclick="selectLevel('A2')">A2 (üî• –í–∏—â–∏–π)</button>
  </div>

  <div id="game" style="display: none;">
    <h3 id="level-display"></h3>
    <p id="score-display"></p>
    <div id="question"></div>
    <input type="text" id="answer" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å">
    <button onclick="checkAnswer()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
    <div id="tower"></div>
  </div>

  <script>
    let scores = JSON.parse(localStorage.getItem('taaltoren_scores')) || { A0: 0, A1: 0, A2: 0 };
    let activeLevel = null;
    let score = 0;
    let currentCSV = [];
    let currentWordIndex = 0;
    let wrongAnswers = 0;

    function selectLevel(level) {
      activeLevel = level;
      score = scores[activeLevel] || 0;
      document.getElementById('level-selection').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById('level-display').innerText = '–†—ñ–≤–µ–Ω—å: ' + activeLevel;
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;

      const csvFile = level === 'A0' ? 'words.csv' : level === 'A1' ? 'words2.csv' : 'words3.csv';
      loadCSV(csvFile);
    }

    function loadCSV(file) {
      fetch(file)
        .then(res => res.text())
        .then(text => {
          const lines = text.trim().split('\n');
          currentCSV = lines.map(line => {
            const [ua, nl] = line.split(',');
            return { ua: ua.trim(), nl: nl.trim() };
          });
          shuffle(currentCSV);
          showNextWord();

          document.getElementById('answer').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') checkAnswer();
          });
        });
    }

    function showNextWord() {
      if (currentCSV.length === 0) return;
      currentWordIndex = Math.floor(Math.random() * currentCSV.length);
      const word = currentCSV[currentWordIndex];
      document.getElementById('question').innerText = `–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏: ${word.ua}`;
      document.getElementById('answer').value = '';
    }

    function checkAnswer() {
      const answer = document.getElementById('answer').value.trim().toLowerCase();
      const correct = currentCSV[currentWordIndex].nl.toLowerCase();

      if (answer === correct) {
        increaseScore();
        addBlock();
        wrongAnswers = 0;
      } else {
        wrongAnswers++;
        if (wrongAnswers >= 3) {
          triggerStorm();
          return;
        }
      }

      showNextWord();
    }

    function increaseScore() {
      score++;
      scores[activeLevel] = score;
      localStorage.setItem('taaltoren_scores', JSON.stringify(scores));
      document.getElementById('score-display').innerText = '–û—á–∫–∏: ' + score;
    }

    function addBlock() {
      const block = document.createElement('div');
      document.getElementById('tower').appendChild(block);
    }

    function clearTower() {
      document.getElementById('tower').innerHTML = '';
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function triggerStorm() {
      alert("–ë—É—Ä—è –∑—Ä—É–π–Ω—É–≤–∞–ª–∞ –≤–∞—à—É –≤–µ–∂—É!");
      clearTower();

      document.getElementById('game').style.display = 'none';
      document.getElementById('level-selection').style.display = 'block';

      const buttons = document.querySelectorAll('#level-selection button');
      const levelOrder = ['A0', 'A1', 'A2'];
      const currentIndex = levelOrder.indexOf(activeLevel);

      buttons.forEach(btn => {
        const level = btn.innerText.includes('A0') ? 'A0' : btn.innerText.includes('A1') ? 'A1' : 'A2';
        const btnIndex = levelOrder.indexOf(level);
        btn.disabled = Math.abs(btnIndex - currentIndex) > 1;
      });
    }
  </script>
</body>
</html>
