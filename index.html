<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>TaalToren — Вежа слів</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
        }
        .tower {
            margin: 20px auto;
            width: 120px;
        }
        .block {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            margin: 2px 0;
            border-radius: 4px;
            animation: drop 0.3s ease;
            word-wrap: break-word;
        }
        @keyframes drop {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .question {
            margin: 20px;
            font-size: 20px;
        }
        .options button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }
        #timer {
            font-size: 18px;
            color: #555;
        }
        #score {
            font-size: 20px;
            color: #333;
        }
        #usernameInput {
            margin-top: 20px;
        }
        #leaderboard {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>TaalToren — Вежа слів</h1>

    <div id="usernameInput">
        <label for="username">Введіть своє ім’я:</label>
        <input type="text" id="username" placeholder="Ім’я">
        <button onclick="startGame()">Почати гру</button>
    </div>

    <div id="game" style="display:none">
        <div id="timer">Наступна буря через: <span id="countdown">15:00</span></div>
        <div id="score">Висота вежі: 0</div>
        <div class="tower" id="tower"></div>
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <div id="leaderboard"></div>
    </div>

    <script>
        const socket = io("https://taaltoren.onrender.com");
        let words = [];
        let usedIndexes = new Set();
        let currentIndex = 0;
        let username = localStorage.getItem("username") || "";
        let tower = [];
        let timer = 900;
        let scores = {};
        let correctWords = new Set(JSON.parse(localStorage.getItem("correctWords") || "[]"));
        let level = parseInt(localStorage.getItem("level") || "1");

        if (username) {
            document.getElementById("usernameInput").style.display = "none";
            document.getElementById("game").style.display = "block";
        }

        async function loadWords() {
            try {
                let file = "/words.csv";
                if (level >= 3) file = "/words3.csv";
                else if (level === 2) file = "/words2.csv";

                const response = await fetch(file);
                const text = await response.text();
                const lines = text.trim().split("\n");
                words = lines.map(line => {
                    const [ua, correct, wrong1, wrong2] = line.split(",");
                    return { ua, correct, wrong: [wrong1, wrong2] };
                });
                shuffle(words);
                nextQuestion();
            } catch (err) {
                document.getElementById("question").innerText = "Не вдалося завантажити слова.";
                console.error("Помилка завантаження CSV:", err);
            }
        }

        socket.on("sync", data => {
            tower = data.tower || [];
            scores = data.scores || {};
            renderTower();
            renderLeaderboard();
        });

        socket.on("clear", () => {
            tower = [];
            correctWords.clear();
            level++;
            localStorage.setItem("level", level);
            localStorage.setItem("correctWords", JSON.stringify([]));
            loadWords();
            renderTower();
        });

        socket.on("tick", data => {
            timer = data.timer;
            updateTimerDisplay();
        });

        function updateTimerDisplay() {
            const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
            const seconds = String(timer % 60).padStart(2, '0');
            document.getElementById("countdown").innerText = `${minutes}:${seconds}`;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function nextQuestion() {
            if (correctWords.size >= words.length) {
                correctWords.clear();
                localStorage.setItem("correctWords", JSON.stringify([]));
            }
            let found = false;
            for (let i = 0; i < words.length; i++) {
                if (!correctWords.has(words[i].correct)) {
                    currentIndex = i;
                    found = true;
                    break;
                }
            }
            if (!found) return;

            const item = words[currentIndex];
            document.getElementById("question").innerText = `Як буде "${item.ua}" нідерландською?`;
            let options = [item.correct, ...item.wrong];
            shuffle(options);

            const optionsDiv = document.getElementById("options");
            optionsDiv.innerHTML = "";
            options.forEach(option => {
                const btn = document.createElement("button");
                btn.innerText = option;
                btn.onclick = () => {
                    if (option === item.correct) {
                        correctWords.add(item.correct);
                        localStorage.setItem("correctWords", JSON.stringify([...correctWords]));
                        socket.emit("add-block", { word: item.correct, user: username });
                        playSound('correct');
                    } else {
                        playSound('wrong');
                    }
                    nextQuestion();
                };
                optionsDiv.appendChild(btn);
            });
        }

        function renderTower() {
            const towerDiv = document.getElementById("tower");
            const scoreDiv = document.getElementById("score");
            towerDiv.innerHTML = "";
            tower.slice().reverse().forEach(entry => {
                const block = document.createElement("div");
                block.className = "block";
                block.innerText = `${entry.word} (${entry.user})`;
                towerDiv.appendChild(block);
            });
            scoreDiv.innerText = `Висота вежі: ${tower.length}`;
        }

        function renderLeaderboard() {
            const lb = document.getElementById("leaderboard");
            lb.innerHTML = `<h3>Рейтинг гравців</h3>`;
            const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
            lb.innerHTML += `<ul>${sorted.map(([name, score]) => `<li>${name}: ${score}</li>`).join('')}</ul>`;
        }

        function playSound(type) {
            const sounds = {
                correct: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_96f7e97907.mp3'),
                wrong: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_88195d96a7.mp3'),
                storm: new Audio('https://cdn.pixabay.com/audio/2022/02/23/audio_1ad76fc186.mp3')
            };
            if (sounds[type]) sounds[type].play();
        }

        function startGame() {
            username = document.getElementById("username").value.trim();
            if (!username) return alert("Введіть ім’я!");
            localStorage.setItem("username", username);
            document.getElementById("usernameInput").style.display = "none";
            document.getElementById("game").style.display = "block";
            loadWords();
        }

        if (username) loadWords();
    </script>
</body>
</html>
